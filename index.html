<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù©Ù©Ù© Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>

  <!-- Google Font (Tajawal) Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ØµÙˆØµ -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Preload Ù„Ù„Ø®Ø· Ø§Ù„Ø®Ø§Øµ (fe.ttf) Ø¨Ù…Ø³Ø§Ø± Ù†Ø³Ø¨ÙŠ ÙŠÙ†Ø§Ø³Ø¨ GitHub Pages -->
  <link rel="preload" as="font" href="./fe.ttf" type="font/ttf">

  <!-- html2canvas Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØµÙˆØ±Ø© -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø®Ø· Ø§Ù„Ø®Ø§Øµ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ */
    @font-face{
      font-family:'FE-Schrift';
      src: url('./fe.ttf') format('truetype');
      font-display: swap;
    }

    :root{
      --digits-font:'FE-Schrift','Tajawal',sans-serif;
      --canvas-w:540px;   /* 9:16 */
      --canvas-h:960px;
    }

    body{font-family:'Tajawal',sans-serif;background:#e9e9e9;padding:16px;text-align:center}
    h2{margin:8px 0 14px}

    /* Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… */
    #capture{
      width:var(--canvas-w);height:var(--canvas-h);margin:0 auto;
      background:url('./bg-9x16.png') no-repeat center/cover;
      position:relative; overflow:hidden; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08);
    }

    /* Ø³Ø­Ø¨ */
    .draggable{ position:absolute; touch-action:none; cursor:move; }
    .plate{ user-select:none }
    .plate>img{ width:100%; height:100%; display:block }
    .zone{ position:absolute; display:flex; align-items:center; justify-content:center; pointer-events:auto; }
    .car-img{width:500px;height:auto;display:block}

    /* ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø· Ù„Ù„Ø£Ø±Ù‚Ø§Ù… */
    .digits-only{
      font-family: var(--digits-font) !important;
      font-variant-numeric: lining-nums;
    }

    .top-category,.car-category{line-height:1;color:#fff;text-shadow:0 0 1px rgba(0,0,0,.35)}
    .top-number,.car-number{line-height:1;color:#000;letter-spacing:.04em}

    .price{font-size:26px;font-weight:700;color:#111;background:transparent;padding:6px 12px;border-radius:10px;user-select:none}
    .price .label{margin-left:6px;color:#000;font-weight:400}

    .controls{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px 12px;justify-content:center}
    .controls label{font-size:14px}
    .controls input,.controls button,.controls select{padding:8px 12px;font-size:15px;font-family:'Tajawal',sans-serif}
  </style>
</head>
<body>

  <h2>ØªØµÙ…ÙŠÙ… Ù„ÙˆØ­Ø© Ø³ÙŠØ§Ø±Ø© Ø£Ø¨ÙˆØ¸Ø¨ÙŠ</h2>

  <div id="capture">
    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ #capture) -->
    <div class="plate draggable" id="topPlate" style="left:20px; top:20px; width:500px; height:110px;">
      <img src="./plate-real.png" alt="Ù„ÙˆØ­Ø© Ø¹Ù„ÙˆÙŠØ©">
      <!-- Ø§Ù„ÙØ¦Ø© (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ topPlate ÙÙ‚Ø·) -->
      <div class="zone draggable" id="topCatZone" style="left:12px; top:8px; width:120px; height:94px;">
        <div class="top-category digits-only" id="topCategory" style="font-size:44px;">1</div>
      </div>
      <!-- Ø§Ù„Ø±Ù‚Ù… (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ topPlate ÙÙ‚Ø·) -->
      <div class="zone draggable" id="topNumZone" style="left:200px; top:6px; width:300px; height:98px;">
        <div class="top-number digits-only" id="topNumber" style="font-size:78px;">12345</div>
      </div>
    </div>

    <!-- Ø§Ù„Ø³ÙŠØ§Ø±Ø© (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ #capture) -->
    <div class="draggable" id="carContainer" style="left:20px; top:220px;">
      <img src="./defender.png" class="car-img" alt="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" id="carImg">
    </div>

    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ #capture) -->
    <div class="plate draggable" id="carPlate" style="left:210px; top:520px; width:150px; height:35px;">
      <img src="./plate-real.png" alt="Ù„ÙˆØ­Ø© Ø³ÙÙ„ÙŠØ©">
      <!-- Ø§Ù„ÙØ¦Ø© (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ carPlate ÙÙ‚Ø·) -->
      <div class="zone draggable" id="carCatZone" style="left:8px; top:0; width:35%; height:100%;">
        <div class="car-category digits-only" id="bottomCategory" style="font-size:10px;">1</div>
      </div>
      <!-- Ø§Ù„Ø±Ù‚Ù… (ØªØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ carPlate ÙÙ‚Ø·) -->
      <div class="zone draggable" id="carNumZone" style="left:42px; top:0; width:62%; height:100%;">
        <div class="car-number digits-only" id="bottomNumber" style="font-size:16px;">12345</div>
      </div>
    </div>

    <!-- Ø§Ù„Ø³Ø¹Ø± (ÙŠØªØ­Ø±Ùƒ Ø¯Ø§Ø®Ù„ #capture) -->
    <div class="price draggable" id="price" style="left:150px; top:760px;">
      <span class="label">Ø§Ù„Ø³Ø¹Ø±:</span>
      <span id="platePrice" class="digits-only">250,000 Ø¯Ø±Ù‡Ù…</span>
    </div>
  </div>

  <!-- Ø§Ù„ØªØ­ÙƒÙ‘Ù… -->
  <div class="controls">
    <label>Ø§Ù„Ø³ÙŠØ§Ø±Ø©:
      <select id="carSelect">
        <option value="defender" selected>Land Rover Defender</option>
        <option value="g_class">Mercedes G-Class</option>
        <option value="patrol_nismo">Nissan Patrol NISMO</option>
      </select>
    </label>

    <label>ÙØ¦Ø© Ø§Ù„Ø±Ù‚Ù…: <input type="text" id="inputCategory" value="1" inputmode="numeric"></label>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©: <input type="text" id="inputNumber" value="12345" inputmode="numeric"></label>
    <label>Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø±Ù‡Ù…): <input type="text" id="inputPrice" value="250000" inputmode="numeric"></label>

    <button id="btnUpdate">ØªØ­Ø¯ÙŠØ«</button>
    <button id="btnDownload">ğŸ“¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
  </div>

  <script>
    /* ØµÙˆØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ù…Ø³Ø§Ø±Ø§Øª Ù†Ø³Ø¨ÙŠØ©) */
    const CAR_PRESETS = {
      defender:{ img:'./defender.png' },
      g_class:{ img:'./g_class.png' },
      patrol_nismo:{ img:'./nissan.png' }
    };

    /* Ø¹Ù†Ø§ØµØ± DOM Ø£Ø³Ø§Ø³ÙŠØ© */
    const captureEl   = document.getElementById('capture');
    const topPlateEl  = document.getElementById('topPlate');
    const topCatZone  = document.getElementById('topCatZone');
    const topNumZone  = document.getElementById('topNumZone');
    const carContEl   = document.getElementById('carContainer');
    const carImgEl    = document.getElementById('carImg');
    const carPlateEl  = document.getElementById('carPlate');
    const carCatZone  = document.getElementById('carCatZone');
    const carNumZone  = document.getElementById('carNumZone');
    const priceEl     = document.getElementById('price');

    const priceFmt = new Intl.NumberFormat('ar-AE');
    const onlyDigits = (s)=> (s||'').toString().replace(/[^0-9]/g,'');

    /* Ø³Ø­Ø¨ Ù…Ø¶Ø¨ÙˆØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®ØµÙ‘ØµØ© */
    function makeDraggable(el, boundsEl){
      let startX=0, startY=0, origL=0, origT=0, dragging=false;
      const pt = (e)=> e.touches ? {x:e.touches[0].clientX,y:e.touches[0].clientY} : {x:e.clientX,y:e.clientY};

      const down = (e)=>{
        e.preventDefault(); e.stopPropagation();
        dragging = true;
        const p = pt(e);
        const r = el.getBoundingClientRect();
        const b = (boundsEl||el.parentElement).getBoundingClientRect();
        startX = p.x; startY = p.y;
        origL = r.left - b.left; origT = r.top - b.top;
        document.addEventListener('mousemove', move, {passive:false});
        document.addEventListener('mouseup', up, {passive:false});
        document.addEventListener('touchmove', move, {passive:false});
        document.addEventListener('touchend', up, {passive:false});
      };

      const move = (e)=>{
        if(!dragging) return;
        e.preventDefault();
        const p = pt(e), dx = p.x-startX, dy = p.y-startY;
        const b = (boundsEl||el.parentElement).getBoundingClientRect();
        const r = el.getBoundingClientRect();
        let L = origL+dx, T = origT+dy;
        L = Math.max(0, Math.min(L, b.width - r.width));
        T = Math.max(0, Math.min(T, b.height - r.height));
        el.style.left = L+'px'; el.style.top = T+'px';
      };

      const up = ()=>{
        dragging=false;
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
        document.removeEventListener('touchmove', move);
        document.removeEventListener('touchend', up);
        saveState(); // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ù‚ÙŠÙ…
      };

      el.addEventListener('mousedown', down);
      el.addEventListener('touchstart', down, {passive:false});
    }

    /* Ø±Ø¨Ø· Ø§Ù„Ø³Ø­Ø¨ */
    makeDraggable(topPlateEl, captureEl);
    makeDraggable(topCatZone, topPlateEl);
    makeDraggable(topNumZone, topPlateEl);
    makeDraggable(carContEl,  captureEl);
    makeDraggable(carPlateEl, captureEl);
    makeDraggable(carCatZone, carPlateEl);
    makeDraggable(carNumZone, carPlateEl);
    makeDraggable(priceEl,    captureEl);

    /* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†ØµÙŠØ© */
    function applyValues(cat, num, priceRaw){
      const c = onlyDigits(cat) || '1';
      const n = onlyDigits(num) || '12345';
      document.getElementById('topCategory').textContent = c;
      document.getElementById('bottomCategory').textContent = c;
      document.getElementById('topNumber').textContent = n;
      document.getElementById('bottomNumber').textContent = n;

      const p = onlyDigits(priceRaw);
      document.getElementById('platePrice').textContent = p ? priceFmt.format(Number(p)) + ' Ø¯Ø±Ù‡Ù…' : '250,000 Ø¯Ø±Ù‡Ù…';

      saveState();
    }

    function applyCarPreset(key){
      const preset = CAR_PRESETS[key];
      if(preset){ carImgEl.src = preset.img; saveState(); }
    }

    document.getElementById('btnUpdate').onclick = ()=> applyValues(
      document.getElementById('inputCategory').value,
      document.getElementById('inputNumber').value,
      document.getElementById('inputPrice').value
    );

    /* ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· */
    async function captureWithFonts(){
      if(document.fonts && document.fonts.ready){
        try{ await document.fonts.ready; }catch{}
      }
      html2canvas(captureEl,{backgroundColor:null,scale:2}).then(c=>{
        const a=document.createElement('a');
        a.download='plate_design.png';
        a.href=c.toDataURL('image/png');
        a.click();
      });
    }
    document.getElementById('btnDownload').onclick = captureWithFonts;

    document.getElementById('carSelect').onchange = (e)=> applyCarPreset(e.target.value);

    /* Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ÙˆØ§Ø¶Ø¹ + Ù‚ÙŠÙ… + Ø§Ù„Ø³ÙŠØ§Ø±Ø©) ÙÙŠ localStorage */
    function saveState(){
      const box = (el)=> ({left:el.style.left, top:el.style.top, width:el.style.width, height:el.style.height});
      const data = {
        pos: {
          topPlate: box(topPlateEl),
          topCatZone: box(topCatZone),
          topNumZone: box(topNumZone),
          carContainer: box(carContEl),
          carPlate: box(carPlateEl),
          carCatZone: box(carCatZone),
          carNumZone: box(carNumZone),
          price: box(priceEl),
        },
        vals: {
          cat: document.getElementById('topCategory').textContent,
          num: document.getElementById('topNumber').textContent,
          price: document.getElementById('platePrice').textContent,
          carSrc: carImgEl.src,
          carKey: document.getElementById('carSelect').value
        }
      };
      localStorage.setItem('plate_state', JSON.stringify(data));
    }

    function loadState(){
      const raw = localStorage.getItem('plate_state'); if(!raw) return;
      const data = JSON.parse(raw);

      const applyBox = (el, b)=>{
        if(!el || !b) return;
        if(b.left)   el.style.left = b.left;
        if(b.top)    el.style.top  = b.top;
        if(b.width)  el.style.width = b.width;
        if(b.height) el.style.height= b.height;
      };

      applyBox(topPlateEl,  data.pos.topPlate);
      applyBox(topCatZone,  data.pos.topCatZone);
      applyBox(topNumZone,  data.pos.topNumZone);
      applyBox(carContEl,   data.pos.carContainer);
      applyBox(carPlateEl,  data.pos.carPlate);
      applyBox(carCatZone,  data.pos.carCatZone);
      applyBox(carNumZone,  data.pos.carNumZone);
      applyBox(priceEl,     data.pos.price);

      document.getElementById('topCategory').textContent  = data.vals.cat || '1';
      document.getElementById('bottomCategory').textContent = data.vals.cat || '1';
      document.getElementById('topNumber').textContent    = data.vals.num || '12345';
      document.getElementById('bottomNumber').textContent = data.vals.num || '12345';
      document.getElementById('platePrice').textContent   = data.vals.price || '250,000 Ø¯Ø±Ù‡Ù…';

      carImgEl.src = data.vals.carSrc || CAR_PRESETS.defender.img;
      if(data.vals.carKey) document.getElementById('carSelect').value = data.vals.carKey;
    }

    /* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© */
    loadState();
  </script>
</body>
</html>
